{% extends "base.html" %}

{% block title %} Dados em tempo Real Sensores {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tempo_real.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
{% endblock %}

{% block content %}
<div class="card-padrao">
    <div class="titulo">
        <p>Dados em Tempo Real dos Sensores</p>
    </div>

    <div id="dados" style="padding: 20px; font-size: 18px;">
        🔄 Carregando dados...
    </div>

    <div style="text-align: center; margin-bottom: 20px;">
        <button id="btnManual" onclick="toggleManual()" style="padding: 10px 20px; background-color: #00b894; color: white; border: none; border-radius: 8px; cursor: pointer;">
            Ligar Manualmente
        </button>
    </div>
</div>

<script>
    let manualStatus = false; // false = desligado, true = ligado

    function toggleManual() {
        manualStatus = !manualStatus;
        const valor = manualStatus ? 1 : 0;

        fetch('/mqtt/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ valor: valor })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('btnManual').innerText = manualStatus ? 'Desligar Manualmente' : 'Ligar Manualmente';
            alert(data.message);
        });
    }

    async function buscarDados() {
        const resp = await fetch('/api/ultimo-log'); // Verifique se sua rota está correta
        const dados = await resp.json();

        if (dados.error) {
            document.getElementById('dados').innerHTML = `<p>❌ ${dados.error}</p>`;
        } else {
            document.getElementById('dados').innerHTML = `
                <p>🌡️ <b>Temperatura:</b> ${dados.temperature} °C</p>
                <p>💧 <b>Umidade do Solo:</b> ${dados.humidity} %</p>
                <p>💨 <b>Umidade do Ar:</b> ${dados.air_humidity} %</p>
                <p>☔ <b>Status Chuva:</b> ${dados.rain_status}</p>
                <p>🚰 <b>Vazão:</b> ${dados.flow_rate} L/s</p>
                <p>🔢 <b>Pulsos:</b> ${dados.pulses}</p>
                <p>🚿 <b>Irrigando:</b> ${dados.is_irrigating ? 'Sim' : 'Não'}</p>
            `;
        }
    }

    setInterval(buscarDados, 2000); // Atualiza a cada 2 segundos
</script>
{% endblock %}
