{% extends "base.html" %}

{% block title %} Dados em tempo Real Sensores {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tempo_real.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
{% endblock %}

{% block content %}
<div class="card-padrao">
    <div class="titulo">
        <p>Dados em Tempo Real dos Sensores</p>
    </div>

    <div id="dados">
        🔄 Carregando dados...
    </div>

    <div class="botao">
        <button id="btnManual" onclick="toggleManual()">
            Ligar Manualmente
        </button>
    </div>
</div>

<script>
    let manualStatus = false;

    function toggleManual() {
        manualStatus = !manualStatus;
        const valor = manualStatus ? 1 : 0;

        fetch('/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ valor: valor })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('btnManual').innerText = manualStatus ? 'Desligar Manualmente' : 'Ligar Manualmente';
            alert(data.message);
        });
    }

    async function buscarDados() {
        const resp = await fetch('/api/ultimo-log');
        const dados = await resp.json();

        if (dados.error) {
            document.getElementById('dados').innerHTML = `<p>❌ ${dados.error}</p>`;
        } else {
            document.getElementById('dados').innerHTML = `
                <div class="card-left">
                    <p>🌡️ <b>Temperatura:</b> ${dados.temperature} °C</p>
                    <p>💧 <b>Umidade do Solo:</b> ${dados.humidity} %</p>
                    <p>💨 <b>Umidade do Ar:</b> ${dados.air_humidity} %</p>
                    <p>☔ <b>Status Chuva:</b> ${dados.rain_status}</p>
                </div>
                <div class="card-right">
                    <p>🚰 <b>Vazão:</b> ${dados.flow_rate} L/s</p>
                    <p>🔢 <b>Pulsos:</b> ${dados.pulses}</p>
                    <p>🚿 <b>Irrigando:</b> ${dados.is_irrigating ? 'Sim' : 'Não'}</p>
                </div>
            `;
        }
    }

    setInterval(buscarDados, 2000);
</script>
{% endblock %}
